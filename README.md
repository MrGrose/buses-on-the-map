# Автобусы на карте Москвы

Веб-приложение показывает передвижение автобусов на карте Москвы.
![Buses](https://github.com/user-attachments/assets/4cb48b37-0da6-4224-b9c3-d2655c0bd754)



## Архитектура
  - `fake_bus` - имитация автобусов
  - `server` - отправляет данные на фронт-браузера, отображаются только те автобусы, которые попадают в области видимость окна браузера
  - `utils` - функционал для загрузки имитации автобусов, парсер агрументов комн. строки при запуске
  - `harmful_bus` / `harmful_client` - ручные скрипты для проверки данных
  - `routes/` - маршруты автобусов

## Как запустить

- Скачайте код
- Откройте в браузере файл index.html

## Настройки

Внизу справа на странице можно включить отладочный режим логгирования и указать нестандартный адрес веб-сокета.

<img src="screenshots/settings.png">

Настройки сохраняются в Local Storage браузера и не пропадают после обновления страницы. Чтобы сбросить настройки удалите ключи из Local Storage с помощью Chrome Dev Tools —> Вкладка Application —> Local Storage.

Если что-то работает не так, как ожидалось, то начните с включения отладочного режима логгирования.


### Предварительные требования
- Python 3.11
- Установленные зависимости requirements.txt

### Установка
1. Клонируйте репозиторий:
```bash
git clone <URL>
cd <directory>
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Пример использования

3. Запуск `fake_bus`:

```bash
python fake_bus.py \
  --server ws://127.0.0.1:8080 \
  --routes_number 20 \
  --buses_on_route 5 \
  --websockets_number 5 \
  --refresh_timeout 0.5 \
  -l
```

Параметры:

  -s, --server — адрес websocket-сервера для отправки данных (по умолчанию: ws://127.0.0.1:8080)

  -r, --routes_number — количество маршрутов (по умолчанию: 20)

  -b, --buses_on_route — автобусов на каждом маршруте (по умолчанию: 5)

  -w, --websockets_number — количество одновременно открытых web-сокетов (по умолчанию: 5)

  -t, --refresh_timeout — задержка обновления координат серверу в секундах (по умолчанию: 0.5)

  -l — отключить дополнительное логирование


4. Запуск `server.py`:
```bash
python server.py \
  --refresh_timeout 0.5 \
  --bus_port 8080 \
  --browser_port 8000 \
  --browser_host 127.0.0.1 \
  -l
```

Параметры:

-t, --refresh_timeout — задержка обновления координат сервером в секундах (по умолчанию: 0.5)

-p, --bus_port — порт для подключения имитатора автобусов (по умолчанию: 8080)

-br, --browser_port — порт для подключения браузера (по умолчанию: 8000)

-bh, --browser_host — хост для браузера (по умолчанию: 127.0.0.1)

-l — отключить дополнительное логирование


## Формат данных

Фронтенд ожидает получить от сервера JSON сообщение со списком автобусов:

```js
{
  "msgType": "Buses",
  "buses": [
    {"busId": "c790сс", "lat": 55.7500, "lng": 37.600, "route": "120"},
    {"busId": "a134aa", "lat": 55.7494, "lng": 37.621, "route": "670к"},
  ]
}
```

Те автобусы, что не попали в список `buses` последнего сообщения от сервера будут удалены с карты.

Фронтенд отслеживает перемещение пользователя по карте и отправляет на сервер новые координаты окна:

```js
{
  "msgType": "newBounds",
  "data": {
    "east_lng": 37.65563964843751,
    "north_lat": 55.77367652953477,
    "south_lat": 55.72628839374007,
    "west_lng": 37.54440307617188,
  },
}
```
---
## Проверка данных
Вся обработка входящих JSON-сообщений на сервере проходит через библиотеку `Pydantic`. Она проверяет, что данные соответствуют строго описанным схемам:

- корректны типы полей,
- обязательные поля присутствуют,
- значения лежат в допустимых пределах.


### 1. Проверка на невалидные сообщения
Запустите скрипт `harmful_bus.py`. Он случайно отправляет различные некорректные и пограничные сообщения на сервер автобусных данных:

```bash
python harmful_bus.py
```
#### Что проверяет:

- пустые сообщения
- неверный формат JSON
- некорректные значения и структуры у автобусов
- отсутствие обязательных полей

Сервер корректно реагирует на каждое невалидное сообщение, отправляя обратно ответ с ошибкой в формате:

```json
{
  "errors": ["Requires valid JSON"],
  "msgType": "Errors"
}
// или
{
  "errors": ["Requires busId specified"],
  "msgType": "Errors"
}

```

### 2. Проверка на устойчивости канала
Для обработки невалидных координат и сообщений браузером `harmful_client.py`:

```bash
python harmful_client.py
```
#### Что проверяет:

- отправка пустых и некорректных сообщений вместо координат
- ошибки в значениях координат
- отсутствие или неверный формат у обязательных полей

Сервер реагирует на каждое невалидное сообщение, отправляя обратно ответ с ошибкой в формате:

```json
{
  "errors": ["Requires valid JSON"],
  "msgType": "Errors"
}
// или
{
  "errors": ["Requires msgType specified"],
  "msgType": "Errors"
}
```
не прерывает соединения по причине исключений при невалидных данных


## Используемые библиотеки

- [Leaflet](https://leafletjs.com/) — отрисовка карты
- [loglevel](https://www.npmjs.com/package/loglevel) для логгирования


## Цели проекта

Код написан в учебных целях — это урок в курсе по Python и веб-разработке на сайте [Devman](https://dvmn.org).
